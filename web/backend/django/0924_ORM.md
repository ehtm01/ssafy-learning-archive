# ORM

### ORM(Object-Relational-Mapping)이란?
- 객체 지향 프로그래밍 언어의 객체(Object)와 데이터베이스의 데이터를 매핑(Mapping)하는 기술
    - 개발자 친화적인 데이터베이스 인터페이스

### 문제 상황: 언어 차이로 인한 소통 불가
- Django는 Python 언어를 사용하지만 데이터베이스는 SQL 언어를 사용함

    ![0924_ORM_2025-09-24-08-59-05](images/0924_ORM_2025-09-24-08-59-05.png)

### ORM의 역할: 번역자 역할
- ORM은 Django와 데이터베이스 사이에서 언어 번역자 역할을 수행

    ![0924_ORM_2025-09-24-08-59-54](images/0924_ORM_2025-09-24-08-59-54.png)

- 마치 외국인과 대화할 때 '통역사'가 중간에서 **언어을 번역**해 주는 것과 유사
- 덕분에 개발자는 DB 구조를 잘 몰라도 파이썬 코드로 쉽게 데이터를 다룰 수 있음
- 코드 작성 시간을 줄이고, 실수를 줄이는 데에 큰 도움이 됨

### Django의 데이터 상호작용: ORM이 일하는 방법
- ORM은 Django 개발자를 위해 'QuerySet API'라는 특별한 도구를 제공
    - QuerySet API는 ORM의 기능을 개발자가 Python 코드 안에서 객체 지향적이고 직관적인 방식으로 DB를 조작할 수 있도록 제공하는 **인터페이스**
    
# QuerySet API

### QuerySet API란?
- DB의 복잡한 SQL 쿼리문을 직관적인 Python 코드로 다룰 수 있게 해주는 강력한 번역기
    - 개발자는 SQL을 직접 작성하지 않고도 .filter(), .exclude(), .order_by() 등 파이썬다운 메서드를 사용해 원하는 데이터를 CRUD 가능
    - 코드의 가독성을 높이고 개발 생산성을 극대화하는 Django ORM의 핵심 기능

### QuerySet API와 ORM의 동작 방식
1. Django -> DB: Django(QuerySet API)에서 ORM을 통해 DB로 정보를 요청할 때
    - SQL 쿼리로 변환되어 DB로 전달
2. DB -> Django: 데이터베이스가 요청에 대한 응답을 보낼 때,
    - ORM은 이 SQL 결과를 다시 파이썬이 이해할 수 있는 Python Object
    - QuerySet 또는 Instance 형태로 변환하여 Django로 반환

        ![0924_ORM_2025-09-24-09-09-31](images/0924_ORM_2025-09-24-09-09-31.png)

### QuerySet API 구문 기본 구조

![0924_ORM_2025-09-24-09-09-59](images/0924_ORM_2025-09-24-09-09-59.png)

- Article(모델 클래스)
    - 역할: DB 테이블에 대한 Python 클래스 표현
    - articles_article 테이블의 스키마(필드, 데이터 타입 등)를 정의하며 Django ORM이 DB와 상호작용할 때 사용하는 기본적인 구조체
- .objects(매니저, manager)
    - 역할: DB 조회(Query) 작업을 위한 기본 인터페이스
    - 모델 클래스가 DB 쿼리 작업을 수행할 수 있도록 하는 진입점
    - Django는 모든 모델에 objects라는 이름의 매니저를 자동으로 추가하며, 이 매니저를 통해 .all(), .filter() 등의 쿼리 메서드를 호출
- .all()(QuertSet API 메서드)
    - 역할: 특정 DB 작업을 수행하는 명령
    - 매니저를 통해 호출하는 메서드로, 해당 모델과 연결된 테이블의 모든 레코드(rows)를 조회하라는 SQL 쿼리를 생성하고 실행

### QuerySet API와 ORM의 동작 방식 예시

![0924_ORM_2025-09-24-09-13-14](images/0924_ORM_2025-09-24-09-13-14.png)

### Query란?
- 데이터베이스에 특정한 데이터를 보여달라는 요청
- "쿼리문을 작성한다."
    - "원하는 **데이터**를 얻기 위해 데이터베이스에 요청을 보낼 **코드**를 작성한다."
- Django에서 Query가 처리되는 과정 정리
    1. 파이썬 코드 -> ORM: 개발자의 QuerySet API(파이썬 코드)가 ORM으로 전달
    2. ORM -> SQL 변환: ORM이 이를 DB용 SQL 쿼리로 변환하여 DB에 전달
    3. DB 응답 -> ORM: DB가 SQL 쿼리를 처리하고 결과 데이터를 ORM에 반환
    4. ORM -> QuerySet 변환: ORM이 데이터베이스의 결과를 QuerySet(파이썬 객체) 형태로 변환하여 우리에게 전달

### QuerySet이란?
- DB에서 전달받은 **객체 목록(데이터 모음)**
- 순회 가능한 데이터로 1개 이상 데이터를 불러와 사용 가능
- Django ORM을 통해 만들어진 자료형
- 단, DB가 단일 객체를 반환할 때는 QuerySet이 아닌 모델(Class)의 인스턴스로 반환

# QuerySet API 실습

### CRUD란?
- 대부분의 소프트웨어가 가지는 기본적인 데이터 처리 기능
- 생성(Create), 조회(Read), 수정(Update), 삭제(Delete)를 묶어 이르는 말
    - Django에서는 QuerySet API를 통해 복잡한 SQL문 없이 Python 코드로 이러한 CRUD 작업을 직관적으로 수행 가능

## Create

### QuerySet API 실습 사전 준비
- 외부 라이브러리 설치 및 의존성 기록
    - IPython은 일반 파이썬 셸(명령창)보다 **자동 완성 등** 편리한 파이썬 **작업 환경**을 만들어주는 도구
        
        `$ pip install ipython`

        `$ pip freeze > requirements.txt`

- Django Shell 접속하기: Django Shell이란?
    - Django 프로젝트의 코드를 명령창에서 바로 실행하고 테스트하는 특별한 파이썬 환경
    - Django 환경 내에서 실행되기 때문에 입력하는 QuerySet API 구문이 Django 프로젝트에 영향을 미침
- Django Shell 접속하기

    `$ python manage.py shell`

    ![0924_ORM_2025-09-24-09-21-42](images/0924_ORM_2025-09-24-09-21-42.png)

- Shell "-v" 옵션 (기본값: 1)
    - 출력 상세도(verbosity level) 설정: 일반적인 정보 외에 더 많은 디버깅 정보나 진행 상황 메시지를 보여달라는 요청
    - 아래 예시는 shell 시작 시 **Django 프로젝트에 등록된 model**이 자동으로 import 된 내용이 출력된 것

        `$ python manage.py shell -v 2`

        ![0924_ORM_2025-09-24-09-23-22](images/0924_ORM_2025-09-24-09-23-22.png)

### 데이터 객체를 만드는(생성하는) 3가지 방법
1. 빈 객체 생성 후 값 할당 및 저장
2. 초기 값과 함께 객체 생성 및 저장
3. create() 메서드로 한 번에 생성 및 저장

### 첫 번째 방법: 빈 객체 생성 후 값 할당 및 저장

![0924_ORM_2025-09-24-09-24-11](images/0924_ORM_2025-09-24-09-24-11.png)

![0924_ORM_2025-09-24-09-24-25](images/0924_ORM_2025-09-24-09-24-25.png)

![0924_ORM_2025-09-24-09-24-35](images/0924_ORM_2025-09-24-09-24-35.png)

### 두 번째 방법: 초기 값과 함께 객체 생성 및 저장

![0924_ORM_2025-09-24-09-24-56](images/0924_ORM_2025-09-24-09-24-56.png)

- 첫 번째 방법, 두 번째 방법 모두 결국 **save 메서드**를 호출해야 비로소 **DB에 데이터**가 저장됨
- 테이블에 한 행(레코드)이 쓰여진 것

### save() 메서드란?
- **객체**를 데이터베이스에 **저장**하는 인스턴스 메서드

---
- save()가 필요한 경우는?
    - 객체를 먼저 생성한 후, DB에 저장하기 전에 추가적인 처리<br>
    (예: 다른 데이터와 관계 설정, 유효성 검사)가 필요할 때 save() 호출

### 세 번째 방법: create() 메서드로 한 번에 생성 및 저장

![0924_ORM_2025-09-24-09-32-44](images/0924_ORM_2025-09-24-09-32-44.png)

- save()를 명시적으로 호출하지 않는 것처럼 보이는 이유는 create() 메서드 자체가 객체 생성과 DB 저장을 한 번에 처리하는 단축 메서드이기 때문

## Read

### 대표적인 조회 메서드
- QuerySet 반환 메서드
    - all()
    - filter()
- QuerySet을 반환하지 않는 메서드
    - get()

### QuerySet 반환 메서드: all()
- 전체 데이터 조회

![0924_ORM_2025-09-24-09-35-01](images/0924_ORM_2025-09-24-09-35-01.png)

### QuerySet 반환 메서드: filter()
- 주어진 매개변수와 일치하는 객체를 포함하는 QuerySet 반환

![0924_ORM_2025-09-24-09-35-31](images/0924_ORM_2025-09-24-09-35-31.png)

### QuerySet을 반환하지 않는 메서드: get()
- 주어진 매개변수와 일치하는 **객체를 반환**

![0924_ORM_2025-09-24-09-35-59](images/0924_ORM_2025-09-24-09-35-59.png)

### get()의 특징
- 객체를 찾을 수 없으면 DoesNotExist 예외를 발생시키고, 둘 이상의 객체를 찾으면 MultipleObjectsReturned 예외를 발생시킴
- 위와 같은 특징을 가지고 있기 때문에 **<u>primary key</u>**와 같이 **고유성(uniqueness)을 보장하는 조회**에서 사용해야 함

    ![0924_ORM_2025-09-24-09-38-27](images/0924_ORM_2025-09-24-09-38-27.png)

---
- Primary key(pk): DB 테이블에서 각 행을 고유하게 식별할 수 있는 속성

## Update

### 데이터 수정 방법
- 인스턴스 변수를 변경 후 save 메서드 호출

![0924_ORM_2025-09-24-09-39-14](images/0924_ORM_2025-09-24-09-39-14.png)

## Delete

### 데이터 삭제 방법
- 삭제하려는 데이터 조회 후 delete 메서드 호출

![0924_ORM_2025-09-24-09-40-17](images/0924_ORM_2025-09-24-09-40-17.png)

# ORM with view

## 전체 게시글 조회

### ORM with view
- View 함수에서 QuerySet API 활용하기
    - View에서의 QuerySet API
        - 웹 페이지에 보여줄 데이터를 DB에서 가져올 때 사용
        - 사용자가 입력한 새로운 데이터를 DB에 저장할 때 사용
            - 2가지 Read(조회)
                1. 전체 게시글 조회 v
                2. 단일 게시글 조회

    ![0924_ORM_2025-09-24-09-41-56](images/0924_ORM_2025-09-24-09-41-56.png)

### 전체 게시글 조회
- 최종 결과화면 미리보기

![0924_ORM_2025-09-24-09-43-09](images/0924_ORM_2025-09-24-09-43-09.png)

- 요청 정의

![0924_ORM_2025-09-24-09-45-24](images/0924_ORM_2025-09-24-09-45-24.png)

![0924_ORM_2025-09-24-09-46-02](images/0924_ORM_2025-09-24-09-46-02.png)

---
- 앱 URL에서 빈 문자열('')의 의미란?
    - 프로젝트 urls.py에서 include("articles.urls")는 articles/로 시작하는 모든 요청을 articles 앱의 urls.py로 넘겨줌
    - 이 때, articles/ 부분은 잘려나가고 나머지 URL만 앱의 urls.py로 전달됨
    - 따라서, <b>path('', views.index)는 articles/ 바로 뒤에 아무것도 없는 경우(articles/ 자체)</b>를 의미, 해당 view 함수를 실행함

---

![0924_ORM_2025-09-24-09-48-41](images/0924_ORM_2025-09-24-09-48-41.png)

# 참고

## Field lookups

### Field lookups: 데이터 필터링의 마법
- 단순 동치 비교(=)를 넘어 더 상세한 조건으로 데이터를 조회할 수 있도록 Django ORM이 제공하는 기능
    - 예를 들어, '**특정 단어가 포함**된 제목', '**특정 날짜 이후**에 작성된 글' 등을 찾을 수 있게 해줌
    - 이를 통해 복잡한 데이터 조회도 파이썬 코드로 간결하고 강력하게 처리 가능

### Field lookups의 간단한 예시
- title 필드가 **'second'**으로 시작하는 Article **데이터(레코드)를 모두** 찾고 싶다면?

    ![0924_ORM_2025-09-24-09-53-42](images/0924_ORM_2025-09-24-09-53-42.png)

- Field Lookups은 모델의 필드 이름 뒤에 <b>이중 밑줄(double underscore, __)</b>을 붙이고, 원하는 조회 유형을 명시하는 방식으로 사용
- filter(), exclude() 및 get() 에 대한 키워드 인자로 지정, 손쉽게 필터링 로직을 구성

    ![0924_ORM_2025-09-24-09-55-46](images/0924_ORM_2025-09-24-09-55-46.png)

### 다양한 조건의 Field lookups 조회 조건
- exact / iexact
    - exact: 대소문자를 구분하여 정확히 일치하는 값을 찾음
    - iexact: 대소문자 구분 없이(대소문자 무시) 정확히 일치하는 값을 찾음
- contains / icontains
    - contains: 문자열 내에 특정 값이 **포함**되어 있는지 (대소문자 구분)
    - icontains: 문자열 포함 여부를 대소문자 구분 없이 확인
- 비교 연산자 (gt, gte, lt, lte)
    - 숫자 또는 날짜 필드에 대해 **크거나 작음**을 비교

> 더 다양한 조회 조건의 종류와 사용 방법은 [공식 문서](https://docs.djangoproject.com/en/5.2/ref/models/querysets/#field-lookups)를 참조

## ORM, QuerySet API를 사용하는 이유
1. DB 추상화
    - 개발자는 특정 DB 시스템에 종속되지 않고 일관된 방식으로 데이터를 다룰 수 있음
2. 생산성 향상
    - 복잡한 SQL 쿼리를 직접 작성하는 대신 Python 코드로 데이터베이스 작업을 수행할 수 있음
3. 객체 지향적 접근
    - DB 테이블을 Python 객체로 다룰 수 있어 객체 지향 프로그래밍의 이점을 활용할 수 있음

### 실습
- ORM
    - 3028. todo 프로젝트 설정과 데이터 조회 (with Shell)
    - 3029. todo 데이터 조회, 생성, 수정 (with Shell)
    - 3030. todo 데이터 삭제와 모델 수정 (with Shell)
